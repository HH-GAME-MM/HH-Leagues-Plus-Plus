// ==UserScript==
// @name         HH Leagues++
// @version      0.7
// @description  Upgrade League with various features
// @author       -MM-
// @match        https://*.hentaiheroes.com/tower-of-fame.html
// @match        https://*.hentaiheroes.com/teams.html
// @match        https://nutaku.haremheroes.com/tower-of-fame.html
// @match        https://nutaku.haremheroes.com/teams.html
// @match        https://*.comixharem.com/tower-of-fame.html
// @match        https://*.comixharem.com/teams.html
// @match        https://*.pornstarharem.com/tower-of-fame.html
// @match        https://*.pornstarharem.com/teams.html
// @match        https://*.gayharem.com/tower-of-fame.html
// @match        https://*.gayharem.com/teams.html
// @run-at       document-end
// @namespace    https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus
// @updateURL    https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/HH-Leagues-Plus-Plus.user.js
// @downloadURL  https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/HH-Leagues-Plus-Plus.user.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=hentaiheroes.com
// @grant        none
// ==/UserScript==

//CHANGELOG: https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/CHANGELOG.md

(function() {
"use strict";function TowerOfFame_css(){let e=document.createElement("style");document.head.appendChild(e),e.sheet.insertRule(".league_end_in { min-width: 110px }"),e.sheet.insertRule("#leagues .league_content .league_buttons {max-width:100% !important;}"),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block {width:20.5rem !important;}"),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block .multiple-battles {height:43px !important;padding-top:6px !important;}"),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block .blue_button_L, #leagues .league_content .league_buttons .league_buttons_block .orange_button_L { display:none !important; width: 116px !important; padding: 10px}"),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block .changeTeam { margin-left:10px;font-size:12px;padding-left:16px !important }"),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history"] .result.unknown { background-image: linear-gradient(to top,#244922 0,#979f96 100%) }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="team"] { column-gap: 3px; }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="team"] .team-theme.icon { width:20px;height:20px }'),e.sheet.insertRule("#leagues .league_content {max-width:49rem !important;}"),e.sheet.insertRule("#leagues .league_table .data-list .data-row.body-row.selected { background-color: rgba(254, 184, 37, .5) }"),e.sheet.insertRule("#leagues .league_table .nicescroll-rails {right:15rem !important;}"),e.sheet.insertRule("#leagues.hidden_girl .league_opponent .player_team_block.opponent {padding-left:0.75rem !important;padding-right:0.75rem !important;}"),e.sheet.insertRule("#leagues .league_opponent .player-panel-buttons {flex-direction: row !important;}"),e.sheet.insertRule("#leagues .league_opponent .player-panel-buttons .battle-action-button.green_button_L {min-width: 50%;}"),e.sheet.insertRule("#leagues .league_opponent .player-profile-picture {cursor:pointer !important;}"),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="level"], #leagues .league_content .league_table .data-list .data-row .data-column[column="player_league_points"], #leagues .league_content .league_table .data-list .data-row .data-column[column="power"], #leagues .league_content .league_table .data-list .data-row .data-column[column="team"], #leagues .league_content .league_table .data-list .data-row .head-column[column="level"], #leagues .league_content .league_table .data-list .data-row .head-column[column="player_league_points"], #leagues .league_content .league_table .data-list .data-row .head-column[column="power"], #leagues .league_content .league_table .data-list .data-row .head-column[column="team"] {\n  min-width: 2rem !important;\n}'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history"], #leagues .league_content .league_table .data-list .data-row .data-column[column="match_history_sorting"], #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history"], #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history_sorting"] {\n  min-width: 5.5rem !important;\n}'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history"] .result, #leagues .league_content .league_table .data-list .data-row .data-column[column="match_history_sorting"] .result, #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history"] .result, #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history_sorting"] .result {\n  width: 1.8rem !important;\n  height: 1.8rem !important;\n  line-height: 1.8rem !important;\n}'),e.sheet.insertRule("#leagues.hidden_girl .league_opponent {\n  position: absolute;\n  right: 0;\n  top: 0;\n  height: 100%;\n  width: 15rem;\n  transition: all .5s;\n  opacity: 1;\n  padding-top: 10px;\n}"),e.sheet.insertRule("#leagues .league_opponent {\n  position: absolute;\n  opacity: 0;\n  right: -13rem;\n  width: 15rem;\n  min-width: 13rem;\n  padding-top: 10px;\n}")}function TowerOfFame_run(){let currentOpponent=null,btn=document.querySelector("#leagues .league_content .league_buttons .league_buttons_block .blue_button_L, #leagues .league_content .league_buttons .league_buttons_block .orange_button_L");null!==btn&&(btn.parentNode.replaceChild(btn.cloneNode(!0),btn),addMultipleBattlesButtonClick()),btn=document.createElement("a"),btn.setAttribute("class","blue_button_L changeTeam"),btn.innerHTML="<div>Change team</div>",btn.addEventListener("click",(function(){localStorage.setItem("battle_type","leagues"),localStorage.setItem("leagues_id",Hero.infos.id),window.location.href="/teams.html"})),document.querySelector(".league_buttons_block").appendChild(btn),document.querySelectorAll("#leagues .league_content .league_buttons .league_buttons_block .blue_button_L, #leagues .league_content .league_buttons .league_buttons_block .orange_button_L").forEach((e=>e.setAttribute("style","display:block !important")));let div=document.createElement("div");div.setAttribute("class","league_opponent"),document.querySelector("#leagues").appendChild(div),$(".head-column").click(modifyDataList),modifyDataList();let btnGirl=document.getElementById("toggle_columns");function modifyDataList(){let e=document.querySelectorAll("#leagues .league_table .data-list .data-row.body-row");for(let t=0;t<e.length;t++){let a=parseInt(e[t].querySelector('.data-column[column="nickname"] .nickname').getAttribute("id-member")),n=opponents_list_getData(a),l=e[t].querySelectorAll('.data-column:not([column="can_fight"])');for(let e=0;e<l.length;e++){if("team"===l[e].getAttribute("column")){let t="";n.player.team.theme_elements.length?n.player.team.theme_elements.forEach((e=>{t+='<img class="team-theme icon " src="'+e.ico_url+'" tooltip="'+e.flavor+'">'})):t='<img class="team-theme icon " src="'+IMAGES_URL+'/pictures/girls_elements/Multicolored.png" tooltip="'+GT.design.balanced_theme_flavor+'">',l[e].innerHTML=t}Hero.infos.id!==a&&"boosters"===l[e].getAttribute("column")&&l[e].querySelectorAll("div[type=booster]").forEach((e=>{0===JSON.parse(e.getAttribute("data-d")).expiration&&e.setAttribute("style","border:1px solid red;opacity:0.5")})),l[e].parentNode.replaceChild(l[e].cloneNode(!0),l[e])}let o=e[t].querySelector('.data-column[column="can_fight"] .go_pre_battle');null!==o&&(o.classList.remove("go_pre_battle"),o.addEventListener("click",(function(){loadingAnimation.start()}))),e[t].addEventListener("click",(e=>selectOpponent(e,n))),currentOpponent===n&&e[t].classList.add("selected")}}function selectOpponent(e,t){document.querySelectorAll("#leagues .league_table .data-list .data-row.body-row").forEach((e=>e.classList.remove("selected"))),e.currentTarget.classList.add("selected"),showOpponent(t)}function showOpponent(e){currentOpponent=e;let t=$("#leagues .league_opponent");t[0].innerHTML="";let a=e.rewards,n=e.match_history;delete e.rewards,delete e.match_history,buildPlayerBlock(e,!1,t),e.rewards=a,e.match_history=n,document.querySelector("#leagues .league_opponent .player-profile-picture").addEventListener("click",(t=>{hero_page_popup({id:e.player.id_fighter})}));let l=getAvailableFights(e),o=document.querySelector("#leagues .league_opponent .player-panel-buttons"),i=document.createElement("div");i.setAttribute("class","green_button_L battle-action-button league-single-battle-button"),i.innerHTML='<div class="action-label">Challenge!</div><div class="action-cost"><div><span class="energy_challenge_icn"></span> x1</div></div>',l>0&&Hero.energies.challenge.amount>0?i.addEventListener("click",(function(){let t=$(event.currentTarget);"disabled"!==t.attr("disabled")&&(t.attr("disabled",!0),loadingAnimation.start(),window.location.href="/league-battle.html?number_of_battles=1&id_opponent="+e.player.id_fighter)})):i.setAttribute("disabled","disabled"),o.appendChild(i);let r=document.createElement("div");r.setAttribute("class","green_button_L battle-action-button league-multiple-battle-button"),r.innerHTML='<div class="action-label">Challenge!</div><div class="action-cost"><div><span class="energy_challenge_icn"></span> x'+(l>1?l:3)+"</div></div>",l>1&&Hero.energies.challenge.amount>1&&l<=Hero.energies.challenge.amount?r.addEventListener("click",(function(){let t=$(event.currentTarget);if("disabled"===t.attr("disabled"))return;t.attr("disabled",!0),i.setAttribute("disabled","disabled"),loadingAnimation.start(),window.history.replaceState(null,"","/leagues-pre-battle.html?id_opponent="+e.player.id_fighter);let a={action:"do_battles_leagues",id_opponent:e.player.id_fighter,number_of_battles:l};hh_ajax(a,(function(t){window.history.replaceState(null,"","/tower-of-fame.html"),t.rewards.redirectUrl="",loadingAnimation.stop(),Reward.handlePopup(t.rewards),Hero.updates(t.hero_changes),fillHistoryAndUpdateOpponentRow(e)}))})):r.setAttribute("disabled","disabled"),o.appendChild(r),hideLeagueGirl(),HHPlusPlus_RunBattleSim(e,l)}function HHPlusPlus_RunBattleSim(opponent_fighter,available_fights){if(!window.HHPlusPlus)return;window.loadedLeagueData||(window.loadedLeagueData=new Map);let loadedData=window.loadedLeagueData.get(opponent_fighter.player.id_fighter);null==loadedData?(window.hero_data=opponents_list_getData(Hero.infos.id).player,window.opponent_fighter=opponent_fighter,available_fights>0&&$.ajax({url:"/leagues-pre-battle.html?id_opponent="+opponent_fighter.player.id_fighter,success:function(data){let html=(new DOMParser).parseFromString(data,"text/html"),scriptNodes=html.querySelectorAll("script:not([src])");for(let i=0;i<scriptNodes.length;i++){let script=scriptNodes[i].innerHTML.trimLeft();if(script.startsWith("var hero_data = {")&&script.includes("var opponent_fighter = {"))return eval(script.replace("var hero_data = {","window.hero_data_tmp = {").replace("var opponent_fighter = {","window.opponent_fighter_tmp = {")),window.loadedLeagueData.set(opponent_fighter.player.id_fighter,{hero_data:window.hero_data_tmp,opponent_fighter:window.opponent_fighter_tmp}),delete window.hero_data_tmp,delete window.opponent_fighter_tmp,void(currentOpponent===opponent_fighter&&showOpponent(opponent_fighter))}}})):(window.hero_data=loadedData.hero_data,window.opponent_fighter=loadedData.opponent_fighter);let simManager=new window.HHPlusPlus.League;const{player:player,opponent:opponent}=simManager.extract(),simulator=new window.HHPlusPlus.Simulator({player:player,opponent:opponent}),result=simulator.run();simManager.display(result),null==loadedData&&document.querySelectorAll("#leagues .league_opponent .matchRating-value").forEach((function(e){e.innerHTML="! "+e.innerHTML+" !"}))}function hideLeagueGirl(){let e=document.getElementById("toggle_columns");null===e||e.classList.contains("hidden_girl")||(e.classList.add("hidden_girl"),document.getElementById("leagues").classList.add("hidden_girl"))}function fillHistoryAndUpdateOpponentRow(e){if(!1!==e.match_history[parseInt(e.player.id_fighter)]){let t="";for(let a=0;a<3;a++){let n=e.match_history[parseInt(e.player.id_fighter)][a];null===n&&(n=e.match_history[parseInt(e.player.id_fighter)][a]={attacker_won:"unknown",match_points:"?"}),t+='<div class="result '+n.attacker_won+'">'+n.match_points+"</div>"}getOpponentColumn(e.player.id_fighter,"match_history").innerHTML=t;let a=getOpponentColumn(e.player.id_fighter,"can_fight");a.innerHTML="",a.parentNode.replaceChild(a.cloneNode(!0),a)}}function getOpponentColumn(e,t){return getOpponentRow(e).querySelector('.data-column[column="'+t+'"]')}function getOpponentRow(e){return document.querySelector('#leagues .league_table .data-list .data-row .data-column[column="nickname"] .nickname[id-member="'+e+'"]').parentNode.parentNode}function getAvailableFights(e){let t=0;if(!1!==e.match_history[parseInt(e.player.id_fighter)])for(let a=0;a<3;a++)null===e.match_history[parseInt(e.player.id_fighter)][a]&&t++;return t}function opponents_list_getData(e){for(let t=0;t<opponents_list.length;t++)if(opponents_list[t].player.id_fighter==e)return opponents_list[t];return null}function addMultipleBattlesButtonClick(){$(".multiple-battles").on("click",(function(){if(confirm("Perform 15x?")){$(this).blur();var e=$(this).attr("price");hc_confirm(e,(function(){return ajaxBattle("challenge",{action:"do_battles_leagues",number_of_battles:15})}))}}))}null===btnGirl&&document.getElementById("leagues").classList.add("hidden_girl")}function Teams_run(){let e=$("#btn-select-team")[0];e.parentNode.replaceChild(e.cloneNode(!0),e),$("#btn-select-team").on("click",(function(e){e.preventDefault();let t=localStorage.getItem("battle_type");var a={action:"select_team",id_team:document.querySelector(".team-slot-container.selected-team").getAttribute("data-id-team"),battle_type:t};hh_ajax(a,(function(e){if(e.redirect_url){var a=e.redirect_url;if("trolls"===t&&(a+="?id_opponent="+localStorageGetItem("troll_id")),"pantheon"===t&&(a+="?id_opponent="+localStorageGetItem("pantheon_id")),"leagues"===t){let e=localStorageGetItem("leagues_id");a=e==Hero.infos.id?"/tower-of-fame.html":"/leagues-pre-battle.html?id_opponent="+e}return window.location.href=a}}))}))}window.location.href.includes(".com/tower-of-fame.html")?(TowerOfFame_css(),setTimeout(TowerOfFame_run,1)):window.location.href.includes(".com/teams.html")&&setTimeout(Teams_run,1);
})();
