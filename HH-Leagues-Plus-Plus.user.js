// ==UserScript==
// @name         HH Leagues++
// @version      0.10.0
// @description  Upgrade League with various features
// @author       -MM-
// @match        https://*.hentaiheroes.com/tower-of-fame.html
// @match        https://nutaku.haremheroes.com/tower-of-fame.html
// @match        https://*.comixharem.com/tower-of-fame.html
// @match        https://*.pornstarharem.com/tower-of-fame.html
// @match        https://*.gayharem.com/tower-of-fame.html
// @run-at       document-end
// @namespace    https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus
// @updateURL    https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/HH-Leagues-Plus-Plus.user.js
// @downloadURL  https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/HH-Leagues-Plus-Plus.user.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=hentaiheroes.com
// @grant        none
// ==/UserScript==

//CHANGELOG: https://github.com/HH-GAME-MM/HH-Leagues-Plus-Plus/raw/main/CHANGELOG.md

(function() {
"use strict";function TowerOfFame_css(){let e=document.createElement("style");document.head.appendChild(e),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block .multiple-battles {height:43px !important;padding-top:6px !important;}"),e.sheet.insertRule("#leagues .league_content .league_buttons .league_buttons_block .blue_button_L, #leagues .league_content .league_buttons .league_buttons_block .orange_button_L { width: 116px !important; padding: 10px; margin-right: 10px }"),e.sheet.insertRule("#leagues .league_content .league_buttons .change_team_container #change_team { width: 116px !important; height: 43px !important; margin-left: 10px; padding: 10px; !important; }"),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history_sorting"] .result.unknown { background-image: linear-gradient(to top,#244922 0,#979f96 100%) }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="team"] { column-gap: 3px; }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="team"] .team-theme.icon { width:20px;height:20px }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="nickname"].clubmate .nickname { color: #00CC00 }'),e.sheet.insertRule("#leagues .league_content {max-width:49rem !important;}"),e.sheet.insertRule("#leagues .league_table .data-list .data-row.body-row.selected { background-color: rgba(254, 184, 37, .5) }"),e.sheet.insertRule("#leagues .league_table .nicescroll-rails {right:15rem !important;}"),e.sheet.insertRule("#leagues .league_opponent .player_team_block.opponent {padding-left:0.75rem !important;padding-right:0.75rem !important;}"),e.sheet.insertRule("#leagues .league_opponent .player-panel-buttons {flex-direction: row !important;}"),e.sheet.insertRule("#leagues .league_opponent .player-panel-buttons .battle-action-button.green_button_L {min-width: 50%;}"),e.sheet.insertRule("#leagues .league_opponent .player-profile-picture {cursor:pointer !important;}"),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="level"], #leagues .league_content .league_table .data-list .data-row .head-column[column="level"], #leagues .league_content .league_table .data-list .data-row .data-column[column="place"], #leagues .league_content .league_table .data-list .data-row .head-column[column="place"] {\n  min-width: 1.4rem !important;\n}'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="player_league_points"], #leagues .league_content .league_table .data-list .data-row .data-column[column="power"], #leagues .league_content .league_table .data-list .data-row .data-column[column="team"], #leagues .league_content .league_table .data-list .data-row .head-column[column="player_league_points"], #leagues .league_content .league_table .data-list .data-row .head-column[column="power"], #leagues .league_content .league_table .data-list .data-row .head-column[column="team"] {\n  min-width: 2rem !important;\n}'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history"], #leagues .league_content .league_table .data-list .data-row .data-column[column="match_history_sorting"], #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history"], #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history_sorting"] {\n  min-width: 5.2rem !important;\n}'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="match_history"] .result, #leagues .league_content .league_table .data-list .data-row .data-column[column="match_history_sorting"] .result, #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history"] .result, #leagues .league_content .league_table .data-list .data-row .head-column[column="match_history_sorting"] .result {\n  width: 1.7rem !important;\n  height: 1.7rem !important;\n  line-height: 1.7rem !important;\n}'),e.sheet.insertRule("#leagues .league_opponent.hidden_girl {\n  position: absolute;\n  right: 0;\n  top: 0;\n  height: 100%;\n  width: 15rem;\n  transition: all .5s;\n  opacity: 1;\n  padding-top: 10px;\n}"),e.sheet.insertRule("#leagues .league_opponent {\n  position: absolute;\n  opacity: 0;\n  right: -13rem;\n  width: 15rem;\n  min-width: 13rem;\n  padding-top: 10px;\n}"),e.sheet.insertRule("#leagues .matchRating { display: block; }"),e.sheet.insertRule("#leagues .league_opponent .matchRating-win-chance { margin-top: 5px; }"),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="power"] .matchRating .matchRating-value { font-size: 12px; }'),e.sheet.insertRule('#leagues .league_content .league_table .data-list .data-row .data-column[column="power"] .matchRating .matchRating-label { display: none; }')}function TowerOfFame_run(){let e=null,t=document.querySelector("#leagues .league_content .league_buttons .league_buttons_block .blue_button_L, #leagues .league_content .league_buttons .league_buttons_block .orange_button_L");null!==t&&(t.parentNode.replaceChild(t.cloneNode(!0),t),$(".multiple-battles").on("click",(function(){if(confirm("Perform 15x?")){$(this).blur();var e=function(){return ajaxBattle("challenge",{action:"do_battles_leagues",number_of_battles:15})},t=$(this).attr("price");hc_confirm(t,e)}})));const a=document.createElement("div");a.setAttribute("class","league_opponent"),document.querySelector("#leagues").appendChild(a);const l=document.querySelector("#leagues div.league_girl");function n(){l.classList.contains("hidden_girl")?a.classList.add("hidden_girl"):a.classList.remove("hidden_girl")}new MutationObserver((e=>{e.forEach((e=>{"attributes"===e.type&&"class"===e.attributeName&&n()}))})).observe(l,{attributes:!0}),n(),$(".head-column").click(u),u();let o=localStorage.getItem("HHLeaguesPlusPlusLastOpponentId");if(null!==o){let e=d(o),t=c(o);null!==e&&null!==t&&i(t,e)}function u(){let t=document.querySelectorAll("#leagues .league_table .data-list .data-row.body-row");for(let a=0;a<t.length;a++){let l=t[a],n=parseInt(l.querySelector('.data-column[column="nickname"] .nickname').getAttribute("id-member")),o=d(n);Hero.infos.id!==n&&null!==Hero.club&&null!==o.player.club&&Hero.club.id_club==o.player.club.id_club&&l.querySelector('.data-column[column="nickname"]').classList.add("clubmate");let u=l.querySelector('.data-column[column="can_fight"] .go_pre_battle');null!==u&&(u.classList.remove("go_pre_battle"),u.addEventListener("click",(function(){loadingAnimation.start()}))),l.addEventListener("click",(e=>i(e.currentTarget,o))),e===o&&l.classList.add("selected")}}function i(e,t){var a;document.querySelectorAll("#leagues .league_table .data-list .data-row.body-row").forEach((e=>e.classList.remove("selected"))),e.classList.add("selected"),r(t),function(){let e=document.getElementById("toggle_columns");null===e||e.classList.contains("hidden_girl")||e.click()}(),a=t.player.id_fighter,localStorage.setItem("HHLeaguesPlusPlusLastOpponentId",a)}function r(t){e=t;let a=$("#leagues .league_opponent");a[0].innerHTML="";let l=t.rewards,n=t.match_history;delete t.rewards,delete t.match_history,buildPlayerBlock(t,!1,a),t.rewards=l,t.match_history=n,document.querySelector("#leagues .league_opponent .player-profile-picture").addEventListener("click",(e=>{hero_page_popup({id:t.player.id_fighter})}));let o=function(e){let t=0;if(!1!==e.match_history[parseInt(e.player.id_fighter)])for(let a=0;a<3;a++)null===e.match_history[parseInt(e.player.id_fighter)][a]&&t++;return t}(t),u=document.querySelector("#leagues .league_opponent .player-panel-buttons"),i=document.createElement("div");i.setAttribute("class","green_button_L battle-action-button league-single-battle-button"),i.innerHTML='<div class="action-label">Challenge!</div><div class="action-cost"><div><span class="energy_challenge_icn"></span> x1</div></div>',o>0&&Hero.energies.challenge.amount>0?i.addEventListener("click",(function(){let e=$(event.currentTarget);"disabled"!==e.attr("disabled")&&(e.attr("disabled",!0),loadingAnimation.start(),window.location.href="/league-battle.html?number_of_battles=1&id_opponent="+t.player.id_fighter)})):i.setAttribute("disabled","disabled"),u.appendChild(i);let r=document.createElement("div");r.setAttribute("class","green_button_L battle-action-button league-multiple-battle-button"),r.innerHTML='<div class="action-label">Challenge!</div><div class="action-cost"><div><span class="energy_challenge_icn"></span> x'+(o>1?o:3)+"</div></div>",o>1&&Hero.energies.challenge.amount>1&&o<=Hero.energies.challenge.amount?r.addEventListener("click",(function(){let e=$(event.currentTarget);if("disabled"===e.attr("disabled"))return;e.attr("disabled",!0),i.setAttribute("disabled","disabled"),loadingAnimation.start(),window.history.replaceState(null,"","/leagues-pre-battle.html?id_opponent="+t.player.id_fighter);let a={action:"do_battles_leagues",id_opponent:t.player.id_fighter,number_of_battles:o};hh_ajax(a,(function(e){window.history.replaceState(null,"","/tower-of-fame.html"),e.rewards.redirectUrl="",loadingAnimation.stop(),Reward.handlePopup(e.rewards),Hero.updates(e.hero_changes),function(e){if(!1!==e.match_history[parseInt(e.player.id_fighter)]){let t="";for(let a=0;a<3;a++){let l=e.match_history[parseInt(e.player.id_fighter)][a];null===l&&(l=e.match_history[parseInt(e.player.id_fighter)][a]={attacker_won:"unknown",match_points:"?"}),t+='<div class="result '+l.attacker_won+'">'+l.match_points+"</div>"}s(e.player.id_fighter,"match_history_sorting").innerHTML=t;let a=s(e.player.id_fighter,"can_fight");a.innerHTML="",a.parentNode.replaceChild(a.cloneNode(!0),a)}}(t)}))})):r.setAttribute("disabled","disabled"),u.appendChild(r),function(e,t){if(!window.HHPlusPlus)return;if(e.sim)(new window.HHPlusPlus.League).display(e.sim);else{window.hero_data=d(Hero.infos.id).player,window.opponent_fighter=e;let t=new window.HHPlusPlus.League;const{player:a,opponent:l}=t.extract(),n=new window.HHPlusPlus.Simulator({player:a,opponent:l}).run();t.display(n),document.querySelectorAll("#leagues .league_opponent .matchRating-value").forEach((function(e){e.innerHTML="! "+e.innerHTML+" !"}))}}(t)}function s(e,t){return c(e).querySelector('.data-column[column="'+t+'"]')}function c(e){let t=document.querySelector('#leagues .league_table .data-list .data-row .data-column[column="nickname"] .nickname[id-member="'+e+'"]');return null!==t?t.parentNode.parentNode:null}function d(e){for(let t=0;t<opponents_list.length;t++)if(opponents_list[t].player.id_fighter==e)return opponents_list[t];return null}$(document).on("league:sim-done",(function(){null!==e&&r(e)}))}TowerOfFame_css(),setTimeout(TowerOfFame_run,1);
})();
